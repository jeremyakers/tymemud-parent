# Archive: 2026-01

## Archived from progress.md (2026-01-05)

### 2026-01-05: MM32 combat — Milestone 0 (stability + log-signal cleanup) progress
- **Fix:** eliminate recurring combat-log SYSERR spam caused by verb-suffix tokens (`$g/$h/$G/$H`) expanding to the empty string (valid case) and `perform_act()` treating empty expansions as fatal.
  - **Files:** `MM32/src/comm.c`
  - **Result:** smoke `server.log` no longer contains:
    - `SYSERR: perform__act got a NULL value on *i!`
    - `SYSERR: bpact got a NULL value on *i!`
- **Hardening:** prevent a NULL bodypart from ever flowing through `executeNormalHit()` if a victim’s bodyparts weren’t initialized yet (edge-case for PCs).
  - **Files:** `MM32/src/turn_based_combat.c`
  - **Result:** no longer emits the old debug line; instead fails safely with a `syserr` and returns early if bodyparts are truly missing.
- **Validation:**
  - `cd MM32/src && make test` (68/68)
  - `cd MM32/src/tests && ./combat_smoke.sh --no-interactive`
  - Latest smoke logs:
    - `MM32/src/tests/test_logs/combat_smoke_20260104_233109/server.log`

### 2026-01-05: MM32 combat — Milestone 1 (typed damage + armor DR) progress
- **Fix:** armor DR now sums absorbance across *all* worn armor that covers the struck bodypart’s `eq_slot` (worn-slot always counts; `covers` adds extra slots), then applies the design **90% soft cap**.
  - **Files:** `MM32/src/fight.c`
  - **Important correctness fix:** slots without a wearflag mapping (e.g., `WEAR_FACE`) no longer incorrectly count as “covered by everything”.
- **Smoke tooling:** added imm-only smoke hooks to set armor absorbance on equipped items and add cross-slot cover flags deterministically (no `oset` prototype edits required).
  - **Files:** `MM32/src/turn_based_combat.c`, `MM32/src/tests/combat_smoke.sh`
  - New hooks:
    - `combat smoke_armor_set <victim> <wear_slot> <pierce> <slash> <crush>`
    - `combat smoke_armor_add_cover <victim> <wear_slot> <target_slot>`
- **Smoke:** added Scenario **2e** that asserts deterministic DR math:
  - Baseline (no armor): raw=10 → final=10
  - One armor piece at 40%: raw=10 → final=6
  - Two pieces totaling 80%: raw=10 → final=2
- **Validation:**
  - `cd MM32/src && make test` (68/68)
  - `cd MM32/src/tests && ./combat_smoke.sh --no-interactive` (pass)
  - Latest smoke logs:
    - `MM32/src/tests/test_logs/combat_smoke_20260105_060820/clients/mud_client_testimp.log`

### 2026-01-05: MM32 combat — Milestone 2 (wounds + death triggers) progress
- **Confirmed:** wound severity flags and instant-death triggers are implemented in `MM32/src/fight.c`:
  - Severity: Minor/Substantial/Gashed/Severed/Broken (percent-of-bodypart-HP).
  - Instant death:
    - `skull` BROKEN → death
    - `heart` GASHED or SEVERED → death
    - `throat` SEVERED → death
- **Smoke:** expanded Scenario 4 to deterministically validate all three critical-part death triggers using `combat smoke_kill`:
  - skull (crush), heart (pierce), throat (pierce)
  - **File:** `MM32/src/tests/combat_smoke.sh`
- **Validation:**
  - `cd MM32/src && make test` (68/68)
  - `cd MM32/src/tests && ./combat_smoke.sh --no-interactive` (pass)
  - Latest smoke logs:
    - `MM32/src/tests/test_logs/combat_smoke_20260105_061527/clients/mud_client_combatA.log`

### 2026-01-05: MM32 combat — Milestone 3 (targeting UX) progress
- **Verified:** player-facing aim token parsing supports both orders:
  - `<command> <target> <aim>`
  - `<command> <aim> <target>`
- **Verified:** region targeting picks a weighted bodypart target (`body_percent`) and prints:
  - `You aim for <victim>'s <bodypart>.`
- **SIT harness hardening:** prevent false-positive “another test is running” failures caused by transient PIDs in `pgrep` output, and ensure SIT shuts down the server it started even when in-game `shutdown` triggers a reboot message.
  - **File:** `MM32/src/tests/test_comprehensive_sit.py`
- **Validation:**
  - `cd MM32/src/tests && python3 -u test_comprehensive_sit.py --test targeting --timeout 300` (pass)

### 2026-01-05: MM32 combat — Milestone 4 (readiness + predictability) progress
- **Verified:** predictability warning triggers under repeated command-class use:
  - `Your repeated motions feel predictable.`
- **Validation:**
  - `cd MM32/src/tests && python3 -u test_comprehensive_sit.py --test predictability --timeout 300` (pass)

### 2025-12-31: Stack-smash / ASan merge + warning hygiene
- **Issue:** Prod crash reported: `*** stack smashing detected ***`
- **Action:** Enabled AddressSanitizer build flags and merged MM3 stable fixes into MM32 via `merge-mm32` (git merge + manual conflict resolution).
- **MM32 merge commit:** `54cdf5d`
- **Post-merge buffer-safety + warning fixes:** `aadf2b0`
- **Decision:** Keep ASan enabled until crash is found (see `memory-bank/techContext.md`).

### 2026-01-03: ASan crash fixes (UAF + weave bounds)
- **Crash:** heap-use-after-free in `comm.c:1205` when `nanny()` can close/free a descriptor during the “process commands” loop.
  - **Fix (MM3):** iterate with `next_d` (safe iteration) instead of `d = d->next`.
  - **MM3 commit:** `46ec002`
- **Crash:** global-buffer-overflow in `weaves.c:getSpellBaseCost()` called from `teaching.c:do_learn` when `find_skill_num()` returns an invalid index.
  - **Fix (MM3):** validate skill number before calling `getSpellBaseCost`, and add bounds guard in `getSpellBaseCost()`.
  - **MM3 commit:** `46ec002`
- **Merge to MM32:** merged and resolved conflicts in `weaves.c` + SIT docs/tests.
  - **MM32 merge commit:** `19752c4`

### 2025-12-31: SIT framework refactor (low-conflict MM3 → MM32 merges)
- **Change:** Split SIT into harness/runner/suites to reduce merge conflicts.
- **Shared plumbing:** `tests/mud_sit_harness.py`, `tests/mud_sit_runner.py`, `tests/sit_suite_base.py`
- **MM32 layer:** `MM32/src/tests/sit_suite_mm32.py` (overrides/extensions)
- **Entrypoints:** `tests/test_comprehensive_sit.py` now thin wrapper calling runner + suite factory
- **Command fix:** MM3 SIT uses `affected` (not `affects`)
- **Commits pushed:**
  - `svn/MM_3_Final`: `87254d5`
  - `svn/MM_3-2_Start`: `5c8b225`

### 2025-12-31: Combat system audit kickoff (MM32)
- **Goal:** Finish MM32 combat system (then channeling) using `Combat_Channeling_Design_Notes/` as the target design.
- **DB findings (tyme):**
  - `class_bodyparts`: 77 rows; includes `throat` and `heart` (heart is inside `chest`), but **no explicit `skull`** row.
  - `class_bodyparts.eq_slot`: currently **0 for all parts** (armor coverage mapping not populated).
  - `form_base.bodypart_regions`: uses a bitmask; regions observed 1..6 correspond to head / arms / torso / legs / feet / hands.
- **Armor storage (MM32):** OLC/UI supports per-type absorbance on `ITEM_ARMOR` using object values **7/8/9** (pierce/slash/crush). Combat code currently subtracts `value0` and must be updated.
- **Nostalgia sources located (MM2):**
  - Forms: `MiT_MM2_Code/src/lib/misc/formdata` (binary; contains classic form names as embedded strings)
  - Weaves: `MiT_MM2_Code/src/weaves.c` / `MiT_MM2_Code/src/weaves.h`
- **Reference docs:** `docs/db/combat-channeling-db.md`, `docs/mm2/nostalgia.md`
- **TODO:** Keep single HP pool for now; later implement separate Health vs Blood pools per design doc.

### 2026-01-01: MM2 forms nostalgia import (MM32)
- **Goal:** Preserve MM2 “feel” by reusing classic form names + notes as MM32 DB-backed forms.
- **Extractor:** `MM32/src/tools/mm2_formdata_extract.py` (parses `MiT_MM2_Code/src/lib/misc/formdata` using MM2 layout from `MiT_MM2_Code/src/fight_forms.c`).
- **Artifacts:**
  - `docs/mm2/mm2_forms_dump.csv` (deterministic dump; **122** forms)
  - `MM32/src/sql_migrations/2026-01-01_mm2_forms_import.sql` (idempotent import into `form_base` + baseline `form_*_text`)
- **Policy:** Import all MM2 forms; mark obvious dev/joke forms as `FORM_EXOTIC` so they aren’t auto-set.
- **Cleanup:** `MM32/src/sql_migrations/2026-01-01_mm2_forms_deduplicate.sql` removes name collisions against pre-existing MM32 forms.

### 2026-01-01: Starter kits (newbie_forms) + smoke validation (MM32)
- **Starter kits migration:** `MM32/src/sql_migrations/2026-01-01_newbie_forms_mm2_starter_kits.sql`
- **Smoke updates:** `MM32/src/tests/combat_smoke.sh` now exercises sword vs mob, spear vs mob, and unarmed PvP sanity using `a kick`.

### 2026-01-01: Combat documentation (players + coders)
- Player guide: `docs/combat/player-combat-guide.md`
- Engine guide: `docs/combat/engine-guide.md`
- Updated smoke testing doc: `docs/testing/mm32-combat-smoke-testing.md`

### 2025-12-31: MM32 combat smoke testing + log findings capture
- Script: `MM32/src/tests/combat_smoke.sh`
- Docs: `docs/testing/mm32-combat-smoke.md`
- Tooling fixes:
  - `MM32/src/tests/mud_client_helper.sh` (allow `send ""`)
  - `MM32/src/tests/mud_client.py` (preserve empty lines when reading cmd file)
- Findings doc: `docs/testing/mm32-combat-log-findings.md`

